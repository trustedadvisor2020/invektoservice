{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "integration-callback-v1.json",
  "title": "Integration Callback Contract",
  "description": "GR-1.9: InvektoServis -> Main App async callback format. InvektoServis sends this payload to Main App's callback endpoint after processing a webhook event.",
  "version": "1.0",

  "endpoint": {
    "method": "POST",
    "path": "{callback_url or Integration:Callback:DefaultCallbackUrl}",
    "auth": "None (internal network, or add shared secret later)",
    "retry": "3x with exponential backoff (500ms, 1s, 2s)"
  },

  "note_for_main_app": "Main App must implement a POST endpoint that accepts this JSON body. Return 2xx for success. Non-2xx triggers retry.",

  "type": "object",
  "required": ["request_id", "action", "tenant_id", "chat_id", "timestamp"],
  "properties": {
    "request_id": {
      "type": "string",
      "description": "Correlation ID -- matches X-Request-Id from original webhook"
    },
    "action": {
      "type": "string",
      "enum": ["send_message", "suggest_reply", "apply_tag", "handoff_to_human", "no_action"],
      "description": "What Main App should do"
    },
    "tenant_id": {
      "type": "integer",
      "description": "Tenant ID (same as JWT tenant_id)"
    },
    "chat_id": {
      "type": "integer",
      "description": "Conversation/chat ID"
    },
    "sequence_id": {
      "type": "integer",
      "description": "Sequence ID from original webhook (for ordering)"
    },
    "data": {
      "type": "object",
      "description": "Action-specific payload",
      "properties": {
        "message_text": { "type": "string", "description": "Message to send (send_message)" },
        "suggested_reply": { "type": "string", "description": "Reply suggestion for agent (suggest_reply)" },
        "tag_name": { "type": "string", "description": "Tag to apply (apply_tag)" },
        "handoff_to_human": { "type": "boolean", "description": "Transfer to human agent" },
        "confidence": { "type": "number", "minimum": 0, "maximum": 1, "description": "AI confidence score" },
        "ai_summary": { "type": "string", "description": "AI summary for agent context" },
        "intent": { "type": "string", "description": "Detected intent (e.g., price_inquiry)" }
      }
    },
    "processing_time_ms": {
      "type": "integer",
      "description": "How long InvektoServis took to process (milliseconds)"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "When InvektoServis generated this callback (ISO 8601)"
    }
  },

  "examples": {
    "send_message_auto_reply": {
      "request_id": "abc123",
      "action": "send_message",
      "tenant_id": 5,
      "chat_id": 12345,
      "sequence_id": 1001,
      "data": {
        "message_text": "Merhaba! Implant fiyatlarimiz 15.000-45.000 TL arasindadir. Ucretsiz muayene icin randevu almak ister misiniz?",
        "confidence": 0.92,
        "intent": "price_inquiry"
      },
      "processing_time_ms": 145,
      "timestamp": "2026-02-08T10:30:01Z"
    },
    "suggest_reply_agent_assist": {
      "request_id": "def456",
      "action": "suggest_reply",
      "tenant_id": 5,
      "chat_id": 12346,
      "sequence_id": 1003,
      "data": {
        "suggested_reply": "Siparisaniz kargoya verildi, takip numarasi: TR123456789.",
        "confidence": 0.78,
        "intent": "cargo_inquiry",
        "ai_summary": "Musteri kargo durumunu soruyor"
      },
      "processing_time_ms": 230,
      "timestamp": "2026-02-08T11:00:01Z"
    },
    "handoff_low_confidence": {
      "request_id": "ghi789",
      "action": "handoff_to_human",
      "tenant_id": 5,
      "chat_id": 12347,
      "sequence_id": 1005,
      "data": {
        "handoff_to_human": true,
        "confidence": 0.35,
        "ai_summary": "Musteri karmasik bir sikayet bildirdi, AI guven esigi altinda"
      },
      "processing_time_ms": 180,
      "timestamp": "2026-02-08T11:15:01Z"
    }
  }
}
