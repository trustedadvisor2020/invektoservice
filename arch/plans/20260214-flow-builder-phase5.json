{
  "schema_version": "3.0",
  "review_protocol_version": "3.0",
  "slug": "20260214-flow-builder-phase5",
  "risk": "MEDIUM",
  "status": "DONE",
  "created_at": "2026-02-14T20:00:00Z",
  "updated_at": "2026-02-14T22:00:00Z",

  "plan": {
    "summary": "Flow Builder Phase 5: Production Integration. Deploy script'e Vite SPA build adimi eklenir (lessons-learned: build unutuldu hatasi onlenir). Build marker'a FlowBuilder SPA bilgisi eklenir. Operational: Q production deploy yapar, DB migration'lari dogrular, WapCRM E2E test yapar.",
    "q_intent": "Phase 5: AutomationOrchestrator v2 production dispatch aktif etme, production deploy (dotnet publish + vite build + NSSM restart), E2E test (WapCRM uzerinden), Flow Builder SPA production erisim kontrolu.",
    "interview_notes": "1) Scope: Sadece Production Integration (iframe/heatmap/polish sonra). 2) V2 rollout: Feature flag gereksiz -- v1 flow hic yok, production DB bos. Flow version:2 dispatch zaten kodda var. 3) Prod config: Claude API key, FAQ data, SSRF config hepsi hazir. 4) Webhook: WapCRM -> Backend:5000 proxy -> Automation:7108 (mevcut mimari). 5) Deploy: Otomatize -- Vite build bat'a ekle (lessons-learned: unutulabilir). 6) Erisim: Login bypass engelli -- mevcut JWT guard (SPA RequireAuth) + API 401 yeterli. Static dosyalar public ama data JWT olmadan erisilemez. 7) E2E: WapCRM Main App API uzerinden WhatsApp mesaji gonderilecek. 8) Production DB: Bos -- ilk flow bu phase'de olusturulacak."
  },

  "interview_decisions": {
    "scope": "Production Integration only -- iframe/heatmap/polish EXCLUDED (future phases)",
    "v2_rollout": "No feature flag needed -- v1 flows dont exist, flow_config.version=2 dispatch already coded",
    "deploy_automation": "Vite build step added to bat script before dotnet publish Backend",
    "auth_model": "Existing SPA RequireAuth + API JWT 401 sufficient -- no additional server-side auth for static files",
    "webhook_routing": "WapCRM -> Backend:5000/api/v1/webhook/event -> Automation:7108 (existing GR-1.9 bridge)",
    "e2e_test": "WapCRM Main App API -- real WhatsApp/Instagram messages through existing integration"
  },

  "implementation_steps": [
    {
      "step": 1,
      "title": "Deploy script -- add FlowBuilder SPA build step",
      "files": ["dev-to-invekto-services.bat"],
      "details": "Before Backend dotnet publish: cd FlowBuilder, npm ci, npx vite build. Error handling: if npm/vite fails, abort. Step numbering update [1/6] through [6/6]. Build marker services array'e FlowBuilder eklenir."
    },
    {
      "step": 2,
      "title": "Verify wwwroot/flow-builder output exists after Vite build",
      "files": [],
      "details": "Bat script icinde: Vite build sonrasi wwwroot/flow-builder/index.html varligini kontrol et. Yoksa hata ver ve dur."
    }
  ],

  "q_operational_tasks": [
    {
      "task": "DB migration check",
      "details": "Production PostgreSQL'de Phase 3a migration uygulanmis mi kontrol et: ALTER TABLE auto_reply_log ADD COLUMN node_id VARCHAR(100). Yoksa calistir.",
      "priority": "HIGH",
      "when": "Deploy oncesi"
    },
    {
      "task": "Deploy",
      "details": "Guncellenmis dev-to-invekto-services.bat calistir. Vite build + dotnet publish + FTPES upload + NSSM restart.",
      "priority": "HIGH",
      "when": "Kod degisikligi sonrasi"
    },
    {
      "task": "Health check",
      "details": "Deploy sonrasi: curl Backend:5000/health, Automation:7108/health. FlowBuilder SPA: https://services.invekto.com:5000/flow-builder/ erisimi.",
      "priority": "HIGH",
      "when": "Deploy sonrasi"
    },
    {
      "task": "Flow Builder ilk flow",
      "details": "SPA'da login (tenant_id + api_key) -> yeni v2 flow olustur -> basit flow (trigger_start -> message_text -> action_handoff) -> aktive et.",
      "priority": "MEDIUM",
      "when": "Health check sonrasi"
    },
    {
      "task": "WapCRM webhook config",
      "details": "WapCRM Main App'te otomasyon webhook URL'ini Backend:5000/api/v1/webhook/event olarak ayarla. Test tenant icin aktive et.",
      "priority": "HIGH",
      "when": "Flow aktive edildikten sonra"
    },
    {
      "task": "E2E WhatsApp test",
      "details": "Test telefondan WhatsApp mesaji gonder -> WapCRM webhook -> Automation v2 flow -> callback -> WapCRM -> WhatsApp cevap. Beklenen: Flow'daki mesaj metninin WhatsApp'ta gorunmesi.",
      "priority": "HIGH",
      "when": "Webhook config sonrasi"
    }
  ],

  "allowed_files": [
    "dev-to-invekto-services.bat",
    "arch/session-memory.md",
    "arch/active-work.md",
    "arch/docs/flow-builder-roadmap.md",
    "arch/plans/20260214-flow-builder-phase5.json"
  ],

  "files_changed": [
    { "path": "dev-to-invekto-services.bat", "is_new": false },
    { "path": "arch/active-work.md", "is_new": false },
    { "path": "arch/session-memory.md", "is_new": false },
    { "path": "arch/plans/20260214-flow-builder-phase5.json", "is_new": true }
  ],

  "git_diff": {
    "sha256": "E48274B00FEA29E5AB1E600A0259ECBC9AD585E7976070A076EA6DCED82C2452",
    "full_path": "arch/plans/diffs/20260214-flow-builder-phase5.diff",
    "stats": {
      "insertions": 251,
      "deletions": 14,
      "files_count": 4
    }
  },

  "build": {
    "status": "N/A (bat script only - no compile step)"
  },

  "verification_questions": [
    {
      "id": "Q1",
      "question": "Deploy script'te Vite build adimi Backend dotnet publish'ten ONCE calistiriliyormu? npm ci/vite build hata verirse script duruyormu?",
      "category": "Process/Policy",
      "codex_answer": null,
      "codex_result": null
    },
    {
      "id": "Q2",
      "question": "Vite build sonrasi wwwroot/flow-builder/index.html varlik kontrolu yapiliyormu? Yoksa script hataliyla duruyormu?",
      "category": "Data",
      "codex_answer": null,
      "codex_result": null
    },
    {
      "id": "Q3",
      "question": "Mevcut deploy script davranisi (5 servis build + FTPES upload + flag-based restart) bozulmuyor mu? Geriye donuk uyumluluk korunuyormu?",
      "category": "Lifecycle",
      "codex_answer": null,
      "codex_result": null
    },
    {
      "id": "Q4",
      "question": "FlowBuilder SPA build adimi mevcut auth/guvenlik yapisini etkiliyor mu? SPA static dosyalari public, API verisi JWT-protected -- bu model korunuyor mu?",
      "category": "Auth",
      "codex_answer": null,
      "codex_result": null
    }
  ],

  "scope_discipline": {
    "forbidden_areas": [
      "src/Invekto.Automation/Services/ -- handler kodu degismez",
      "src/Invekto.Backend/FlowBuilder/src/ -- SPA kodu degismez",
      "src/Invekto.Shared/ -- shared contracts degismez",
      "arch/contracts/ -- kontratlar degismez"
    ],
    "non_goals": [
      "iframe embed (Phase 5a roadmap)",
      "AHA #7 Trafik Heatmap (Phase 5b roadmap)",
      "UX polish / auto-save / shortcuts (Phase 5c roadmap)",
      "Feature flag / gradual rollout (v1 yok, gereksiz)",
      "Server-side static file auth (JS public, data JWT-protected)"
    ],
    "intentional_exclusions": [
      "WapCRM webhook config -- Q operational task, kod degisikligi degil",
      "DB migration -- Q operational task, production DB'de calistirilacak",
      "E2E test -- Q operational task, manual WhatsApp test"
    ]
  },

  "error_handling": {
    "try_catch_locations": [],
    "user_facing_errors": [
      "Deploy script: [ERROR] FlowBuilder SPA build failed!",
      "Deploy script: [ERROR] FlowBuilder SPA output not found!"
    ],
    "silent_failure_risk": false,
    "silent_failure_explanation": "Deploy script changes are visible in console output. Vite build failure stops the entire deploy process. No silent paths."
  },

  "aha_moments": [
    {
      "category": "RELIABILITY",
      "user_pain": "Deploy script Vite build adimi icermiyor -- Q her deploy oncesi elle vite build calistirmak zorunda, unutursa production'da eski SPA kalir.",
      "suggestion": "Deploy script'e otomatik npm ci + vite build ekle. Build output yoksa deploy'u durdur.",
      "aha_moment": "Q deploy butonuna bastiginda hem backend hem SPA otomatik build edilir. Bir daha 'JS eksik' hatasi yasamaz."
    },
    {
      "category": "UX",
      "user_pain": "Production'da Flow Builder SPA'ya ilk kez erisecek admin nereden baslamali bilmiyor. Login sonrasi bos flow listesi goruyor.",
      "suggestion": "Bos flow listesinde 'Ilk Flow'unu Olustur' CTA butonu ve 3 adimli mini tutorial ekle (Phase 5c scope'unda).",
      "aha_moment": "Admin login yapar, 'Ilk Flow'unu Olustur' butonuna tiklar ve 60 saniyede calisan bir chatbot flow'u olusturur."
    },
    {
      "category": "SPEED",
      "user_pain": "Deploy script tum servisleri her seferinde build ediyor -- sadece Backend degisse bile Automation/ChatAnalysis build edilir.",
      "suggestion": "Selective build: degisen servisleri git diff ile tespit et, sadece onlari build et. (Gelecek iyilestirme)",
      "aha_moment": "Deploy suresi 5 servis yerine 1 servis build'i kadar kisa olur -- 2dk yerine 30sn."
    },
    {
      "category": "SUPPORT",
      "user_pain": "Production'da v2 flow hata verdiginde Q debug icin sunucuya baglanip log dosyalarini karistirmak zorunda.",
      "suggestion": "FlowEngineV2 execution log'larini /ops endpoint'ine ekle: son 50 v2 execution path + error. (Phase 5c scope'unda)",
      "aha_moment": "Q browser'dan /ops acip son 10 dakikadaki tum flow execution'lari ve hatalari gorebilir."
    },
    {
      "category": "SALES",
      "user_pain": "Yeni musteri adayi icin chatbot demo gostermek zor -- production tenant lazim, gercek WhatsApp numarasi lazim.",
      "suggestion": "Demo mode: Simulator'u web-based yap, QR kodsuz canli demo. (Gelecek faz)",
      "aha_moment": "Sales gorusmesinde 'Chatbot'unuzu gorun' linki paylasir, musteri adayi telefonundan canli chatbot dener."
    }
  ],

  "verdict": {
    "status": "FORCE_PASS",
    "iteration": 3,
    "blocking_issues": [],
    "force_pass_reason": "SHA256 circular dependency (plan JSON in diff = hash always stale). Actual code (bat script) FULL PASS all 3 iters. Q approved."
  }
}
